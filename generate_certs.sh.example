#!/usr/bin/env bash

# Create a directory to store the certificates safely
# NOTE: Ensure 'certs/' is in your .gitignore file!
mkdir -p certs
cd certs

echo "ğŸ”’ 1. Generating the Root Certificate Authority (CA)..."
openssl req -new -x509 -days 365 -nodes -newkey rsa:2048 \
  -keyout ca.key -out ca.crt \
  -subj "/C=<<INSERT_COUNTRY_CODE>>/ST=<<INSERT_STATE>>/L=<<INSERT_CITY>>/O=<<INSERT_ORGANIZATION>>/CN=<<INSERT_ORG>>-Root-CA"

echo "ğŸ¢ 2. Generating the Mosquitto Broker Certificate..."
openssl genrsa -out broker.key 2048
openssl req -new -key broker.key -out broker.csr \
  -subj "/C=<<INSERT_COUNTRY_CODE>>/ST=<<INSERT_STATE>>/L=<<INSERT_CITY>>/O=<<INSERT_ORGANIZATION>>/CN=<<INSERT_BROKER_NAME>>"
openssl x509 -req -in broker.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out broker.crt -days 365

echo "âš™ï¸ 3. Generating the Rust Agent (Edge) Certificate..."
openssl genrsa -out rust_agent.key 2048
openssl req -new -key rust_agent.key -out rust_agent.csr \
  -subj "/C=<<INSERT_COUNTRY_CODE>>/ST=<<INSERT_STATE>>/L=<<INSERT_CITY>>/O=<<INSERT_ORGANIZATION>>/CN=<<INSERT_AGENT_NAME>>"
openssl x509 -req -in rust_agent.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out rust_agent.crt -days 365

echo "ğŸ’» 4. Generating the React Dashboard Certificate..."
openssl genrsa -out dashboard.key 2048
openssl req -new -key dashboard.key -out dashboard.csr \
  -subj "/C=<<INSERT_COUNTRY_CODE>>/ST=<<INSERT_STATE>>/L=<<INSERT_CITY>>/O=<<INSERT_ORGANIZATION>>/CN=<<INSERT_DASHBOARD_NAME>>"
openssl x509 -req -in dashboard.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out dashboard.crt -days 365

echo "ğŸ“Š 5. Generating the Telegraf Bridge Certificate..."

openssl genrsa -out telegraf.key 2048
openssl req -new -key telegraf.key -out telegraf.csr \
  -subj "/C=<<INSERT_COUNTRY_CODE>>/ST=<<INSERT_STATE>>/L=<<INSERT_CITY>>/O=<<INSERT_ORGANIZATION>>/CN=<<INSERT_TELEGRAF_NAME>>"
openssl x509 -req -in telegraf.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out telegraf.crt -days 365
rm telegraf.csr

echo "ğŸ” 6. Exporting the React Dashboard Certificate to PKCS#12 format..."

openssl pkcs12 -export -out dashboard.p12 -inkey dashboard.key -in dashboard.crt -certfile ca.crt

# Cleanup the temporary CSR files
rm *.csr

echo "âœ… All X.509 certificates generated successfully in the ./certs directory!"